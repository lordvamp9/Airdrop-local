<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureLink Space - Glossy Workspace</title>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass-white: rgba(255, 255, 255, 0.65);
            --glossy-blue-bright: #38bdf8;
            --glossy-blue-dark: #0284c7;
            --glossy-blue: linear-gradient(180deg, var(--glossy-blue-bright) 0%, var(--glossy-blue-dark) 100%);
            --glossy-silver: linear-gradient(180deg, #ffffff 0%, #e2e8f0 100%);
            --glossy-green: linear-gradient(180deg, #4ade80 0%, #16a34a 100%);
            --text-navy: #0c4a6e;
            --accent: #0ea5e9;
            --success: #22c55e;
            --error: #ef4444;
            --reflection: linear-gradient(135deg, rgba(255, 255, 255, 0.4) 0%, transparent 50%, rgba(255, 255, 255, 0.1) 100%);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0ea5e9 url('background.png') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: var(--text-navy);
            overflow: hidden;
        }

        .window {
            width: 100%;
            max-width: 500px;
            background: var(--glass-white);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border-radius: 40px;
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow:
                0 40px 80px rgba(0, 0, 0, 0.2),
                inset 0 1px 2px rgba(255, 255, 255, 1),
                inset 0 -5px 15px rgba(0, 0, 0, 0.05);
            padding: 45px;
            position: relative;
            transform: translateZ(0);
            animation: windowEnter 1s cubic-bezier(0.19, 1, 0.22, 1);
            overflow: hidden;
        }

        /* Glass reflection overlay */
        .window::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: var(--reflection);
            pointer-events: none;
            z-index: 10;
        }

        @keyframes windowEnter {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(40px) rotateX(-5deg);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0) rotateX(0deg);
            }
        }

        header {
            text-align: center;
            margin-bottom: 35px;
            position: relative;
            z-index: 2;
        }

        h1 {
            font-weight: 800;
            letter-spacing: -1px;
            text-shadow: 0 2px 4px rgba(255, 255, 255, 0.8);
            background: linear-gradient(180deg, #075985, #0ea5e9);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            background: #94a3b8;
            border-radius: 50%;
            margin-right: 10px;
            display: inline-block;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .status-dot.active {
            background: var(--success);
            box-shadow: 0 0 15px var(--success), 0 2px 4px rgba(0, 0, 0, 0.1);
            animation: pulseGlow 2s infinite;
        }

        @keyframes pulseGlow {
            50% {
                filter: brightness(1.3);
                transform: scale(1.1);
            }
        }

        .connection-status {
            font-size: 14px;
            font-weight: 700;
            color: #475569;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.4);
            padding: 10px;
            border-radius: 50px;
            border: 1px solid white;
        }

        .section {
            display: none;
            flex-direction: column;
            gap: 25px;
            position: relative;
            z-index: 2;
        }

        .section.active {
            display: flex;
            animation: sectionSlide 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }

        @keyframes sectionSlide {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .btn {
            position: relative;
            padding: 20px 30px;
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.8);
            font-size: 17px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            box-shadow:
                0 10px 20px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            overflow: hidden;
        }

        .btn-primary {
            background: var(--glossy-blue);
            color: white;
            border-color: #0369a1;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 45%;
            background: linear-gradient(rgba(255, 255, 255, 0.45), rgba(255, 255, 255, 0.1));
            border-radius: 20px 20px 100% 100%;
        }

        .btn-secondary {
            background: var(--glossy-silver);
            color: var(--text-navy);
            border-color: #cbd5e1;
        }

        .btn-secondary::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 45%;
            background: linear-gradient(rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.2));
            border-radius: 20px 20px 100% 100%;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            filter: brightness(1.1);
        }

        .btn:active {
            transform: translateY(1px) scale(0.98);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        .qr-area {
            text-align: center;
            background: white;
            padding: 30px;
            border-radius: 30px;
            box-shadow:
                inset 0 4px 10px rgba(0, 0, 0, 0.05),
                0 10px 30px rgba(0, 0, 0, 0.05);
            margin-bottom: 10px;
            border: 2px solid rgba(255, 255, 255, 0.9);
            position: relative;
        }

        #qr-code {
            display: inline-block;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #qr-code:hover {
            transform: scale(1.05);
        }

        .file-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 280px;
            overflow-y: auto;
            padding: 10px 5px;
        }

        .file-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 18px;
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            animation: slideUp 0.4s cubic-bezier(0, 0.55, 0.45, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .file-icon {
            width: 46px;
            height: 46px;
            background: var(--glossy-blue-bright);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
            box-shadow: inset 0 1px 3px rgba(255, 255, 255, 0.5);
        }

        .progress-bar-small {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 100px;
            margin-top: 10px;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .progress-fill-small {
            height: 100%;
            background: var(--glossy-green);
            width: 0%;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .progress-fill-small::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 100px;
        }

        #reader {
            width: 100%;
            border-radius: 25px;
            overflow: hidden;
            border: 6px solid white;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        @media (max-width: 480px) {
            .window {
                padding: 35px 25px;
                border-radius: 32px;
                width: 92%;
                max-width: none;
                margin: 20px auto;
                backdrop-filter: blur(20px) saturate(180%);
            }

            body {
                padding: 0;
                overflow-y: auto;
            }
        }

        input[type="file"] {
            display: none !important;
            visibility: hidden;
            position: absolute;
        }
    </style>
</head>

<body>
    <div class="window">
        <header>
            <h1 style="font-size: 28px;">SecureLink Space</h1>
        </header>

        <div id="section-lobby" class="section active">
            <div class="connection-status">
                <div class="status-dot active"></div>
                <span>Your Identity: <span id="my-id-text">...</span></span>
            </div>
            <div id="auto-connecting-status" class="hidden" style="text-align: center; margin-bottom: 20px;">
                <div class="status-dot active"></div>
                <span style="font-weight: 700; color: var(--accent);">Connecting to Space...</span>
            </div>
            <div id="lobby-default">
                <p style="text-align: center; font-size: 14px; color: #64748b; margin-bottom: 20px;">
                    Scan the code from another device to connect.
                </p>
                <div class="qr-area">
                    <div id="qr-code"></div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                    <button class="btn btn-secondary" onclick="toggleJoin(true)">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path
                                d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                            <circle cx="12" cy="13" r="4" />
                        </svg>
                        Join Workspace (Scan)
                    </button>
                    <p style="text-align: center; font-size: 11px; opacity: 0.5;">Identity resets on refresh.</p>
                </div>
            </div>
            <div id="lobby-join" class="hidden">
                <div id="reader"></div>
                <button class="btn btn-secondary" onclick="toggleJoin(false)" style="width: 100%;">Cancel
                    Camera</button>
            </div>
        </div>

        <div id="section-dashboard" class="section">
            <div class="dashboard-header">
                <div class="connection-status" style="justify-content: flex-start; margin-bottom: 0;">
                    <div class="status-dot active"></div>
                    <span style="color: var(--success);">Connected Space Active</span>
                </div>
            </div>
            <input type="file" id="file-input" onchange="handleFileSelect(this)" multiple>
            <label for="file-input" class="btn btn-primary">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                    <polyline points="17 8 12 3 7 8" />
                    <line x1="12" y1="3" x2="12" y2="15" />
                </svg>
                Upload to Space
            </label>
            <div style="margin-top: 15px;">
                <p style="font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 10px;">Shared Transfers</p>
                <div id="file-queue" class="file-list">
                    <p id="no-files-msg" style="text-align: center; font-size: 12px; opacity: 0.5; padding: 20px;">No
                        active transfers in this space.</p>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="location.reload()"
                style="margin-top: 15px; border: none; background: none; box-shadow: none; font-size: 13px; color: #f43f5e;">
                Terminate Workspace
            </button>
        </div>
    </div>

    <script>
        const EPHEMERAL_ID = 'sl-' + Array.from(crypto.getRandomValues(new Uint8Array(5))).map(b => b.toString(16).padStart(2, '0')).join('');
        let peer = null, conn = null, html5QrCode = null, activeTransfers = {};

        function initPeer() {
            peer = new Peer(EPHEMERAL_ID, {
                debug: 1,
                config: { 'iceServers': [{ urls: 'stun:stun.l.google.com:19302' }] }
            });

            peer.on('open', (id) => {
                document.getElementById('my-id-text').textContent = id;
                const joinUrl = 'https://lordvamp9.github.io/Airdrop-local/' + '?join=' + id;
                new QRCode(document.getElementById('qr-code'), { text: joinUrl, width: 180, height: 180, colorDark: "#075985", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H });

                const urlParams = new URLSearchParams(window.location.search);
                const joinId = urlParams.get('join');
                if (joinId && joinId !== id) {
                    document.getElementById('auto-connecting-status').classList.remove('hidden');
                    document.getElementById('lobby-default').classList.add('hidden');
                    // Give the peer system a brief moment to be fully ready
                    setTimeout(() => connectToPeer(joinId), 500);
                }
            });

            peer.on('connection', (c) => setupConnection(c));
        }

        async function toggleJoin(enable) {
            const def = document.getElementById('lobby-default'), join = document.getElementById('lobby-join');
            if (enable) {
                def.classList.add('hidden'); join.classList.remove('hidden');
                html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (id) => { toggleJoin(false); connectToPeer(id); });
            } else {
                def.classList.remove('hidden'); join.classList.add('hidden');
                if (html5QrCode) await html5QrCode.stop();
                html5QrCode = null;
            }
        }

        function connectToPeer(id) { setupConnection(peer.connect(id, { secure: true })); }

        function setupConnection(connection) {
            conn = connection;
            conn.on('open', () => { document.getElementById('section-lobby').classList.remove('active'); document.getElementById('section-dashboard').classList.add('active'); });
            conn.on('data', (data) => handleIncoming(data));
            conn.on('close', () => location.reload());
        }

        function handleIncoming(data) {
            if (data.type === 'metadata') createFileItem(data.id, data.name, data.size, 'incoming');
            else if (data.type === 'chunk') {
                const t = activeTransfers[data.id]; if (!t) return;
                t.chunks.push(data.buffer); t.received += data.buffer.byteLength;
                updateItemProgress(data.id, (t.received / t.total) * 100);
                if (t.received >= t.total) finalizeTransfer(data.id);
            } else if (data.type === 'signal') {
                if (data.action === 'accept') startSending(data.id);
                if (data.action === 'reject') removeItem(data.id);
            }
        }

        function createFileItem(id, name, size, mode) {
            document.getElementById('no-files-msg').classList.add('hidden');
            const q = document.getElementById('file-queue'), i = document.createElement('div');
            i.className = 'file-item'; i.id = `file-${id}`;
            i.innerHTML = `<div class="file-info" style="width: 100%"><div class="file-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg></div><div style="flex: 1; overflow: hidden;"><div class="file-name">${name}</div><div class="file-size">${formatBytes(size)} • ${mode === 'incoming' ? 'Waiting' : 'Ready'}</div><div class="progress-bar-small"><div class="progress-fill-small" id="fill-${id}"></div></div></div><div class="action-btns" id="actions-${id}">${mode === 'incoming' ? `<button class="action-btn btn-accept" onclick="respondTransfer('${id}', 'accept')">Accept</button><button class="action-btn btn-cancel" onclick="respondTransfer('${id}', 'reject')">×</button>` : `<div style="font-size: 10px; font-weight: 700; color: #64748b;">PENDING</div>`}</div></div>`;
            q.prepend(i); activeTransfers[id] = { name, total: size, received: 0, chunks: [], mode };
        }

        function respondTransfer(id, action) {
            const t = activeTransfers[id]; if (!t) return;
            if (action === 'accept') { document.getElementById(`actions-${id}`).innerHTML = '<div style="font-size: 10px; font-weight: 700; color: var(--accent);">DOWNLOADING</div>'; conn.send({ type: 'signal', action: 'accept', id: id }); }
            else { conn.send({ type: 'signal', action: 'reject', id: id }); removeItem(id); }
        }

        async function handleFileSelect(input) {
            for (const file of input.files) {
                const id = Math.random().toString(36).substr(2, 9);
                createFileItem(id, file.name, file.size, 'outgoing');
                activeTransfers[id].fileObject = file;
                conn.send({ type: 'metadata', id, name: file.name, size: file.size });
            }
            input.value = '';
        }

        async function startSending(id) {
            const t = activeTransfers[id], file = t.fileObject, chunkSize = 65536;
            document.getElementById(`actions-${id}`).innerHTML = '<div style="font-size: 10px; font-weight: 700; color: var(--accent);">SENDING</div>';
            for (let o = 0; o < file.size; o += chunkSize) {
                const c = file.slice(o, o + chunkSize);
                conn.send({ type: 'chunk', id, buffer: await c.arrayBuffer() });
                updateItemProgress(id, Math.min((o / file.size) * 100, 100));
                if (o % (chunkSize * 20) === 0) await new Promise(r => setTimeout(r, 10));
            }
            updateItemProgress(id, 100);
            document.getElementById(`actions-${id}`).innerHTML = '<div style="font-size: 10px; font-weight: 700; color: var(--success);">SENT</div>';
        }

        function updateItemProgress(id, pct) { const f = document.getElementById(`fill-${id}`); if (f) f.style.width = pct + '%'; }

        function finalizeTransfer(id) {
            const t = activeTransfers[id], b = new Blob(t.chunks), u = URL.createObjectURL(b), a = document.createElement('a');
            a.href = u; a.download = t.name; a.click();
            document.getElementById(`actions-${id}`).innerHTML = '<div style="font-size: 10px; font-weight: 700; color: var(--success);">SAVED</div>';
            setTimeout(() => URL.revokeObjectURL(u), 1000);
        }

        function removeItem(id) { const e = document.getElementById(`file-${id}`); if (e) e.remove(); delete activeTransfers[id]; if (Object.keys(activeTransfers).length === 0) document.getElementById('no-files-msg').classList.remove('hidden'); }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024, s = ['B', 'KB', 'MB', 'GB'], i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + s[i];
        }

        initPeer();
    </script>
</body>

</html>